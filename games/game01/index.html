<!DOCTYPE html>
<html lang="ja">
	<head>
		<!-- 文字コードを指定 -->
		<meta charset = 'utf-8'>

		<!-- タイトル -->
		<title>ブロック崩し</title>
		<style>
*{ padding: 0; margin: 0; }
canvas { background: #eee; display: block; margin: 0 auto; }
		</style>

		<!-- スマホ表示対応 -->
		<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes" />

		<link rel="icon" href="../../icon.png">

		<!-- スタイル指定 -->
		<link rel="stylesheet" href="../../styles.css">
		<link rel="stylesheet" href="./style.css">
	</head>

	<body>
		<p>
		<h1>ブロック崩し</h1>
		</p>
		<!-- <canvas>要素はゲームを描画する -->
		<!-- <canvas>要素は簡単に参照を取得できるようにmyCanvasというidを持つ -->
		<canvas id="myCanvas" width="480" height="320"></canvas>


		<p>
		<script>
			/* <canvas>要素へ描画するには、まずJavascriptから<canvas>要素への参照を取得しなければならない */
			/* <canvas>要素への参照をcanvasに保存 */
			var canvas = document.getElementById("myCanvas");

/* 2D描画コンテキストを保存するためにctx変数を作成 */
var ctx = canvas.getContext("2d");

var x = canvas.width/2;		// ボールの初期位置
var y = canvas.height-30;	// ボールの初期位置

var dx = 2.0;			// ボールの速度
var dy = -2.0;			// ボールの速度

var ballRadius = 10;		// ボールの半径
var paddleHeight = 10;		// パドルの高さ
var paddleWidth = 200;		// パドルの幅
var paddleX = (canvas.width-paddleWidth)/2;	// パドルの初期位置

var rightPressed = false;	// アローキー右の状態
var leftPressed = false;	// アローキー左の状態

var ballColor = "#0095DD";	// ボールの色
var paddleColor = "#0095DD"	// パドルの色

var brickRowCount	= 3;	// ブロックの行数
var brickColumnCount	= 5;	// ブロックの列数
var brickWidth		= 75;	// ブロックの幅
var brickHeight		= 20;	// ブロックの高さ
var brickPadding	= 10;	// ブロックの間隙
var brickOffsetTop	= 30;	// ブロックの上端の隙間
var brickOffsetLeft	= 30;	// ブロックの左端からの相対位置
var score		= 0;	// スコア

/* 1つの二次元配列ですべてのブロックを記録する。 */
var bricks		= [];
for(var col=0; col<brickColumnCount; col++)
{
	bricks[col] = [];
	for(var row=0; row<brickRowCount; row++)
	{
		bricks[col][row] = { x: 0, y: 0, status: 1 };
	}
}


/* ブロックの描画 */
function drawBricks()
{
	for(var col=0; col<brickColumnCount; col++)
	{
		for(var row=0; row<brickRowCount; row++)
		{/* 衝突検出関数 */
function collisionDetection()
{
	for(var col=0; col<brickColumnCount; col++)
	{
		for(var row=0; row<brickColumnCount; row++)
		{
			var b = bricks[col][row];
			if(b.status == 1)
			{
				if(x > b.x && x < b.x+brickWidth && y > b.y && y < b.y+brickHeight)
				{
					dy = -dy;
					b.status = 0;
				}
			}
		}
	}
}

			if(bricks[col][row].status == 1)
			{
				var brickX = (col*(brickWidth+brickPadding))+brickOffsetLeft;
				var brickY = (row*(brickHeight+brickPadding))+brickOffsetTop;
				bricks[col][row].x = brickX;
				bricks[col][row].y = brickY;
				ctx.beginPath();
				ctx.rect(brickX, brickY, brickWidth, brickHeight);
				ctx.fillStyle = "#0095DD";
				ctx.fill();
				ctx.closePath();
			}
		}
	}
}

/* パドルの描画 */
function drawPaddle()
{
	ctx.beginPath();
	ctx.rect(paddleX, canvas.height-paddleHeight, paddleWidth, paddleHeight);
	ctx.fillStyle = paddleColor;
	ctx.fill();
	ctx.closePath();
}

/* 以下２つの関数はどちらも変数eで表されるイベントをパラメーターとして受け取る。 */
/* 大抵のブラウザではアローキー左右にArrowLeftとArrowRightが対応しているが、IE/EdgeではLeftとRightも確認する必要がある。 */

/* イベントリスナーがキーの押下によるイベントの発火を検知すると、keyDownHandlerが実行され、その情報が変数xxxPressedに保存される。 */
function keyDownHandler(e)
{
	if(e.key == "Right" || e.key == "ArrowRight")
	{
		rightPressed = true;
	} else {
		if(e.key == "Left" || e.key == "ArrowLeft")
		{
			leftPressed = true;
		}
	}
}

/* イベントリスナーがキーの引きによるイベントの発火を検知すると、keyUpHandlerが実行され、その情報が変数xxxPressedに保存される。 */
function keyUpHandler(e)
{
	if(e.key == "Right" || e.key == "ArrowRight")
	{
		rightPressed = false;
	} else {
		if(e.key == "Left" || e.key == "ArrowLeft")
		{
			leftPressed = false;
		}
	}
}

/* 衝突検出関数 */
function collisionDetection()
{
	for(var col=0; col<brickColumnCount; col++)
	{
		for(var row=0; row<brickRowCount; row++)
		{
			var b = bricks[col][row];
			if(b.status == 1)
			{
				if(x > b.x && x < b.x+brickWidth && y > b.y && y < b.y+brickHeight)
				{
					dy = -dy;
					b.status = 0;
					score++;
					if(score == brickRowCount*brickColumnCount)
					{
						alert("YOU WIN, CONGRATULATIONS!");
						document.location.reload();
					}
					ballColor = ballColor == "#0095DD" ? "#DD9500" : "#0095DD";
				}
			}
		}
	}
}

function drawScore()
{
	ctx.font = "16px Arial";
	ctx.fillStyle = "#0095DD";
	ctx.fillText("Score: "+score, 8, 20);
}


/* ボールの描画 */
function drawBall()
{
	ctx.beginPath();
	ctx.arc(x, y, ballRadius, 0, Math.PI*2);
	ctx.fillStyle=ballColor;
	ctx.fill();
	ctx.closePath();
}

/* メインの描画ループ */
function draw()
{
	/* 画面の初期化 */
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	drawBricks();
	drawBall();		// ボールを描画
	collisionDetection();	// 衝突を検出
	drawPaddle();		// パドルを描画
	drawScore();
	if(rightPressed)	// アローキー右が押された際の動作
	{
		if(paddleX < canvas.width-paddleWidth)
		{
			paddleX += 7;
		}
	}
	if(leftPressed)		// アローキー左が押された際の動作
	{
		if(paddleX > 0)
		{
			paddleX -= 7;
		}
	}
	x += dx;		// ボールの座標を更新
	y += dy;		// ボールの座標を更新
	if(y + dy < ballRadius)	// ボールが上端に触れた場合、y方向の速度を逆転させる
	{
		dy = -dy;
	} else {		// ボールが上端に触れていない場合
		/* ボールがパドルと同じ高さの領域に侵入した場合 */
		if(y+dy > canvas.height-ballRadius-paddleHeight)
		{
			/* ボールのx座標がパドルの内側に収まっていた場合、y方向の速度を逆転させ、ボールのスピードを上げる */
			if(paddleX < x && x<paddleX + paddleWidth)
			{
				dy = -dy;
				dx *= 1.05;
				dy *= 1.05;
			} else {	// ボールがパドルと同じ高さの領域に侵入し、かつx座標がパドルの内側に収まっていなかった場合
				/* ゲームオーバー */
				alert("GAME OVER");

				/* ページの再読み込み */
				document.location.reload();
				/* Needed for Chrome */
				clearInterval(interval);
			}
		}
	}
	/* ボールが左右の画面端に侵入した場合は、x方向の速度を逆転させる。 */
	if(x + dx > canvas.width-ballRadius || x + dy < ballRadius)
	{
		dx = -dx;
	}
}
/* キーの押下または引きによるイベントの発火を検知し、指定された関数keyDownHandlerまたはkeyUpHandlerを実行するためのイベントリスナーを設定 */
document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);
var interval = setInterval(draw, 10);

		</script>
		</p>
		<p style="text-align:center">操作方法：アローキー左右<br>
		※このゲームを動作させるにはJavaScriptを有効にする必要があります。<br>
		※スマホでのプレイには対応していません。</p>

		<p>
		<hr />

		<h2>参考文献</h2>
		<ul>
			<li><a href="https://developer.mozilla.org/ja/docs/Games/Tutorials/2D_Breakout_game_pure_JavaScript">そのままのJavascriptを使ったブロックくずしゲーム - ゲーム開発 | MDN</a></li>
		</ul>
		</p>
		<a href="../index.html">ゲーム一覧へ戻る</a>
	</body>
</html>
